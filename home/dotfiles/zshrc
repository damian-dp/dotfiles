# Damian's zshrc.local
# Managed by nix dotfiles
# 
# NOTE: This file is sourced by home-manager's generated .zshrc
# Oh-my-zsh and powerlevel10k are managed by home-manager (see home/core.nix)

# =============================================================================
# Oh-My-Zsh Settings
# =============================================================================
DISABLE_AUTO_TITLE="true"

# =============================================================================
# Terminal Color Support
# =============================================================================
# Ensure truecolor (24-bit color) is advertised to applications
# Required for proper theming in tools like OpenCode, especially inside tmux
export COLORTERM=truecolor

# =============================================================================
# 1Password
# =============================================================================
# SSH Agent
if [[ -S "$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock" ]]; then
  # macOS
  export SSH_AUTH_SOCK="$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
elif [[ -S "$HOME/.1password/agent.sock" ]]; then
  # Linux
  export SSH_AUTH_SOCK="$HOME/.1password/agent.sock"
fi

# Service account token (headless VMs - saved by bootstrap-vm.sh)
if [[ -z "$OP_SERVICE_ACCOUNT_TOKEN" ]] && [[ -f "$HOME/.config/op/service-account-token" ]]; then
  export OP_SERVICE_ACCOUNT_TOKEN=$(cat "$HOME/.config/op/service-account-token")
fi


# =============================================================================
# Node.js (NVM)
# =============================================================================
export NVM_DIR="$HOME/.nvm"
[[ -s "$NVM_DIR/nvm.sh" ]] && source "$NVM_DIR/nvm.sh"
[[ -s "$NVM_DIR/bash_completion" ]] && source "$NVM_DIR/bash_completion"

# GitHub NPM token (macOS only - lazy-load via function)
# VM uses pnpm wrapper at ~/.local/bin/pnpm instead (no shell startup delay)
if [[ -z "$OP_SERVICE_ACCOUNT_TOKEN" ]]; then
  gh_npm_token() {
    if [[ -z "$GH_NPM_TOKEN" ]]; then
      export GH_NPM_TOKEN=$(/opt/homebrew/bin/op read "op://Employee/4xwfq5opt6k5e6vlpskxpn5vaa/token" 2>/dev/null)
    fi
    echo "$GH_NPM_TOKEN"
  }
fi

# =============================================================================
# Package Managers
# =============================================================================
# pnpm
if [[ "$OSTYPE" == "darwin"* ]]; then
  export PNPM_HOME="$HOME/Library/pnpm"
else
  export PNPM_HOME="$HOME/.local/share/pnpm"
fi
[[ -d "$PNPM_HOME" ]] && export PATH="$PNPM_HOME:$PATH"

# bun
export BUN_INSTALL="$HOME/.bun"
[[ -d "$BUN_INSTALL" ]] && export PATH="$BUN_INSTALL/bin:$PATH"
[[ -s "$BUN_INSTALL/_bun" ]] && source "$BUN_INSTALL/_bun"

# =============================================================================
# PATH
# =============================================================================
export PATH="$HOME/.local/bin:$PATH"

# Antigravity (AI coding)
[[ -d "$HOME/.antigravity/antigravity/bin" ]] && export PATH="$HOME/.antigravity/antigravity/bin:$PATH"

# Homebrew (macOS)
if [[ "$OSTYPE" == "darwin"* ]]; then
  export PATH="/opt/homebrew/bin:$PATH"
  export PATH="/opt/homebrew/opt/postgresql@17/bin:$PATH"
fi

# =============================================================================
# Tools
# =============================================================================
# opencode
export OPENCODE_EXPERIMENTAL="true"
[[ -d "$HOME/.opencode/bin" ]] && export PATH="$HOME/.opencode/bin:$PATH"
OPENCODE_VM_URL="http://vm:4096"
# Map local project dirs to VM paths for opencode --dir
# Paths use /home/damian (Linux VM), not $HOME (macOS /Users/damian)
typeset -A _opencode_vm_dirs=(
  [cubitt]="/home/damian/code/tilt/cubitt"
  [mobius]="/home/damian/code/tilt/mobius"
  [dotfiles]="/home/damian/code/dotfiles"
)
opencode() {
  local mode dir_args=()

  # Check for --project shorthand flags (e.g. --cubitt, --mobius, --dotfiles)
  local args=()
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --cubitt|--mobius|--dotfiles)
        local project="${1#--}"
        dir_args=(--dir "${_opencode_vm_dirs[$project]}")
        ;;
      *) args+=("$1") ;;
    esac
    shift
  done
  set -- "${args[@]}"

  if [[ "$1" == "local" ]]; then
    shift
    mode="local"
  elif [[ "$1" == "vm" ]]; then
    shift
    mode="vm"
  else
    # Default: try VM, fall back to local
    if curl -s --connect-timeout 2 --max-time 3 "$OPENCODE_VM_URL" >/dev/null 2>&1; then
      mode="vm"
    else
      mode="local (VM unreachable)"
    fi
  fi

  # Auto-detect project dir from cwd when connecting to VM (if no --project flag)
  if [[ "$mode" == vm && ${#dir_args[@]} -eq 0 ]]; then
    case "$PWD" in
      */code/tilt/cubitt*)  dir_args=(--dir "${_opencode_vm_dirs[cubitt]}") ;;
      */code/tilt/mobius*)  dir_args=(--dir "${_opencode_vm_dirs[mobius]}") ;;
      */code/dotfiles*)     dir_args=(--dir "${_opencode_vm_dirs[dotfiles]}") ;;
    esac
  fi

  echo "[$(date '+%H:%M:%S')] opencode: $mode ${dir_args[*]}" >> ~/.local/state/opencode.log
  if [[ "$mode" == vm ]]; then
    command opencode attach "$OPENCODE_VM_URL" "${dir_args[@]}" "$@"
  else
    command opencode "$@"
  fi
}

# LM Studio (macOS)
[[ -d "$HOME/.lmstudio/bin" ]] && export PATH="$PATH:$HOME/.lmstudio/bin"

# =============================================================================
# Aliases
# =============================================================================
alias ll="ls -la"
alias gs="git status"
alias gp="git push"
alias gl="git pull"

# AI coding
alias vibe-claude="claude --dangerously-skip-permissions"

# tmux
alias ta="tmux attach -t"
alias tl="tmux ls"
alias tn="tmux new -s"

# =============================================================================
# Shell Functions
# =============================================================================
# commit() - Claude-powered commit message generator
[[ -f "$HOME/.config/shell/commit.sh" ]] && source "$HOME/.config/shell/commit.sh"

# dotfiles-sync - copy live writable configs back to dotfiles repo
# These are copy-once files that apps write to at runtime
dotfiles-sync() {
  local dotfiles="${DOTFILES:-$HOME/code/dotfiles}"
  if [[ ! -d "$dotfiles" ]]; then
    echo "Dotfiles repo not found at $dotfiles"
    echo "Set DOTFILES env var to override."
    return 1
  fi

  local synced=0

  # OpenCode configs
  for f in opencode.json oh-my-opencode.json package.json; do
    local src="$HOME/.config/opencode/$f"
    local dst="$dotfiles/home/dotfiles/opencode/$f"
    if [[ -f "$src" ]] && ! diff -q "$src" "$dst" &>/dev/null; then
      cp "$src" "$dst"
      echo "Synced: opencode/$f"
      ((synced++))
    fi
  done

  # Claude CLI settings
  local src="$HOME/.claude/settings.json"
  local dst="$dotfiles/home/dotfiles/claude/settings.json"
  if [[ -f "$src" ]] && ! diff -q "$src" "$dst" &>/dev/null; then
    cp "$src" "$dst"
    echo "Synced: claude/settings.json"
    ((synced++))
  fi

  if ((synced == 0)); then
    echo "Everything already in sync."
  else
    echo ""
    echo "$synced file(s) synced. Review changes with:"
    echo "  cd $dotfiles && git diff"
  fi
}

# =============================================================================
# Powerlevel10k Config
# =============================================================================
[[ -f "$HOME/.p10k.zsh" ]] && source "$HOME/.p10k.zsh"
